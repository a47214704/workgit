<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>编辑收款方式</title>
    <link rel="stylesheet" type="text/css" href="../css/mui.min.css"/>
    <link href="../css/mui.picker.min.css" rel="stylesheet" />
	<link href="../css/mui.poppicker.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="../css/own.css"/>
    <style type="text/css">
    	.mui-input-row label {width: 100%; color: #00B82B}
    	.upload-row {padding:11px 15px; line-height: 1.1; color: #333333; height: 50px!important;}
    	.qrcode-con {text-align: center; padding:15px 0; display: none;}
    	.qrcode-con img {width: 150px; height: 150px; margin:0 auto}
    	.selected select {font-size: 15px; padding:10px 15px}
    	.mui-icon-arrowdown {position: absolute; right: 10px; top:8px; pointer-events: none;}
    </style>
</head>
<body>
	<header class="mui-bar mui-bar-nav own-bar-nav">
		<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		<h1 class="mui-title">添加收款方式</h1>
	</header>
	
	<div class="mui-content" style="margin: 10px">
		<form class="mui-input-group">
			<div class="mui-input-row selected">
				<select id="channelPicker">
				</select>
				<span class="mui-icon mui-icon-arrowdown"></span>
			</div>
			<div id="qrcodeWay">
				<div class="mui-input-row" id="accountDiv">
					<input type="text" class="mui-input-clear" id="account" placeholder="收款账号" />
				</div>
				<div class="mui-input-row" class="mui-input-clear">
					<input type="text" class="mui-input-clear" id="username" placeholder="收款人" />
				</div>
				<div class="mui-input-row" class="mui-input-clear">
					<input type="number" class="mui-input-clear" id="qrDaliylimit" value="10000" placeholder="每日收款上限" />
				</div>
				<div class="mui-input-row upload-row" id="uploadBtn">
					<span class="mui-icon mui-icon-camera"></span>
					上传收款二维码
				</div>
				<div class="qrcode-con" id="qrcodeCon">
					<img src="" id="qrcodeImg"/>
				</div>
			</div>
			<div id="bankWay" style="display: none;">
				<div class="mui-input-row">
					<input type="number" class="mui-input-clear" id="bankCard" placeholder="银行卡卡号" />
				</div>
				<div class="mui-input-row" class="mui-input-clear">
					<input type="text" class="mui-input-clear" id="bankUser" placeholder="持卡人姓名" />
				</div>
				<div class="mui-input-row selected">
					<select id="bankCardPicker"></select>
					<span class="mui-icon mui-icon-arrowdown"></span>
				</div>
				<div class="mui-input-row" class="mui-input-clear">
					<input type="number" class="mui-input-clear" id="bankDaliylimit" value="30000" placeholder="每日收款上限" />
				</div>
			</div>
			<div id="aliRedEnvelopeWay" style="display: none;">
				<div class="mui-input-row">
					<input type="text" class="mui-input-clear" id="aliUserId" placeholder="支付宝编号" />
				</div>
				<div class="mui-input-row" class="mui-input-clear">
					<input type="text" class="mui-input-clear" id="aliAccountId" placeholder="支付宝账户" />
				</div>
				<div class="mui-input-row" class="mui-input-clear">
					<input type="text" class="mui-input-clear" id="aliUserName" placeholder="支付宝昵称" />
				</div>
				<div class="mui-input-row" class="mui-input-clear">
					<input type="number" class="mui-input-clear" id="aliDaliylimit" value="10000" placeholder="每日收款上限" />
				</div>
			</div>
		</form>
		
		<div class="mui-button-row" style="margin-top: 10px;">
			<button type="button" id="saveBtn" class="mui-btn own-btn-green mui-btn-block" style="padding: 5px 0px;">保存</button>
		</div>
	</div>
	<script type="text/javascript" src="../js/mui.min.js" ></script>
	<script src="../js/mui.picker.min.js"></script>
	<script src="../js/mui.poppicker.js"></script>
	<script type="text/javascript" src="../js/own.js" ></script>
	<script type="text/javascript" src="../js/network.js" ></script>
	<script type="text/javascript">
		var BankNameList = [
			'中国工商银行',
			'中国农业银行',
			'中国银行',
			'中国建设银行',
			'中国交通银行',
			'中国招商银行',
			'中信银行',
			'中国民生银行',
			'中国光大银行',
			'中国平安银行',
			'上海浦东发展银行',
			'中国邮政储蓄银行',
			'华夏银行',
			'兴业银行',
			'北京银行',
			'上海银行',
			'广东发展银行'
		];
		mui.init({
			swipeBack:true
		});
		
		var channelPicker;
		var bankCardPicker;
		var saveBtn;
		var uploadBtn;
		var selectedChannelId = 0;
		var selectedChannelType;
		var selectedBankCard;
		var qrcodeImg;
		var qrcodeCon;
		var imageBase64Data;
		var channels = new Array();
		
		var account;
		var username;
		var bankCard;
		var bankUser;
		var bankName;
		var aliUserId;
		var aliAccountId;
		var aliUserName;
		var qrDaliylimit;
		var bankDaliylimit;
		var aliDaliylimit;
		
		var defaultLimit = [];
		
		mui.plusReady(function() {
			channelPicker = document.getElementById("channelPicker");
			bankCardPicker = document.getElementById("bankCardPicker"); 
			saveBtn = document.getElementById("saveBtn");
			uploadBtn = document.getElementById('uploadBtn');
			qrcodeCon = document.getElementById("qrcodeCon");
			qrcodeImg = document.getElementById("qrcodeImg");
			account = document.getElementById("account");
			username = document.getElementById("username");
			bankCard = document.getElementById("bankCard");
			bankUser = document.getElementById("bankUser");
			bankName = document.getElementById("bankName");
			aliUserId = document.getElementById("aliUserId");
			aliAccountId = document.getElementById("aliAccountId");
			aliUserName = document.getElementById("aliUserName");
			qrDaliylimit = document.getElementById("qrDaliylimit");
			aliDaliylimit = document.getElementById("aliDaliylimit");
			bankDaliylimit = document.getElementById("bankDaliylimit");
			
			channelPicker.addEventListener('change', function() {
				selectedChannelId = this.value;
				channelChange(channels[selectedChannelId],defaultLimit[selectedChannelId]);
			}, false);
			
			bankCardPicker.addEventListener('change', function() {
				selectedBankCard = BankNameList[this.value];
			}, false);
			
			//保存
			saveBtn.addEventListener('tap', function() {
				if (selectedChannelId == 0) {
					mui.toast('请选择收款方式');
					return;
				}
				
				var collectData;
				switch(selectedChannelType){
					case 1://微信
						if (account.value.length <= 0) {
							mui.toast('请填写收款账号');
							return;
						}
						if (username.value.length <= 0) {
							mui.toast('请填写收款人');
							return;
						}
						if (!imageBase64Data) {
							mui.toast('请上传收款二维码');
							return;
						}
						
						collectData = {
							name: account.value + '_' + selectedChannelId,
							channel: {
								id: selectedChannelId,
							},
							originalQrCode: imageBase64Data,
							accountProvider:'',
							accountHolder:username.value,
							accountName:account.value,
							dailyLimit:qrDaliylimit.value
						};
						break;
					case 2://银行卡
						if (bankCard.value.length <= 0 || !isBankCard(bankCard.value)) {
							mui.toast('请填写正确的银行卡号');
							return;
						}
						if (selectedBankCard.length <= 0) {
							mui.toast('请选择银行名称');
							return;
						}
						if (bankUser.value.length <= 0) {
							mui.toast('请填写持卡人姓名');
							return;
						}
						
						collectData = {
							name: bankUser.value + '_' + selectedChannelId,
							channel: {
								id: selectedChannelId,
							},
							qrCode: '',
							accountProvider:selectedBankCard,
							accountHolder:bankUser.value,
							accountName:bankCard.value,
							dailyLimit:bankDaliylimit.value
						};
						break;
					case 3://支付宝
						if (aliUserId.value.length <= 0) {
							mui.toast('请填写支付宝编号');
							return;
						}
						if (aliAccountId.value.length <= 0) {
							mui.toast('请填写支付宝账户');
							return;
						}
						if (aliUserName.value.length <= 0) {
							mui.toast('请填写支付宝昵称');
							return;
						}						
						collectData = {
							name: 'ali_' + aliUserId.value + '_' + selectedChannelId,
							channel: {
								id: selectedChannelId,
							},
							qeCode: '',
							accountProvider:aliUserId.value,
							accountHolder:aliUserName.value,
							accountName:aliAccountId.value,
							dailyLimit:aliDaliylimit.value
						};
						break;
					case 4:
						if (username.value.length <= 0) {
							mui.toast('请填写收款人');
							return;
						}
						if (!imageBase64Data) {
							mui.toast('请上传收款二维码');
							return;
						}
						
						collectData = {
							name: username.value + '_' + selectedChannelId,
							channel: {
								id: selectedChannelId,
							},
							originalQrCode: imageBase64Data,
							accountProvider:'',
							accountHolder:username.value,
							accountName:'',
							dailyLimit:qrDaliylimit.value
						};
						break;
				}
				if (collectData) {
					network.save_collect_instrument(collectData);
				}				
			}, false);
			
			//上传二维码
			uploadBtn.addEventListener('tap', function() {
				plus.gallery.pick(
			        function(path) {
			            qrcodeImg.src = path;
						qrcodeCon.style.display = 'block';
			            qrcodeImg.onload = function() {
			                var imgData = getBase64Image(qrcodeImg); 
			            	var newImgbase = imgData.split(",");
			               	var extBase = newImgbase[0].split("/");
			               	var ext = extBase[1].split(";")[0];
			               	imageBase64Data = ext + '.' + newImgbase[1];
			            }
			        },
		            function(e) {
		                mui.toast('取消选择');
		            });
			}, false);
			
			getBankCardPicker();
			network.get_collect_channel();
		});
		
		function getBankCardPicker() {
			var options = '<option value="" disabled selected>请选择银行名称</option>';
			
			mui.each(BankNameList, function(index, item) {	
				options += '<option value="'+ index +'">';
				options += item;
				options += '</option>';
			});
			bankCardPicker.innerHTML = options;
		}
		
		function getChannelSuccess(data) {
			if (data.result) {
				var options = '';
				mui.each(data.result, function(index, item) {
					if (selectedChannelId == 0) {
						selectedChannelId = item.id;
						channelChange(item.channelType, item.defaultDaliyLimit);
					}
					
					defaultLimit[item.id] = item.defaultDaliyLimit;
					channels[item.id] = item.channelType;
					
					options += '<option value="'+item.id+'">';
					options += item.name;
					options += '</option>';
				});
				this.channelPicker.innerHTML = options;
			}
		}
		
		function saveCollectInstrumentSuccess(data) {
			account.value = '';
			username.value = '';
			qrcodeCon.style.display = 'none';
			bankCard.value = '';
			selectedBankCard = '';
			bankUser.value = '';
			mui.toast('收款方式添加成功');
			mui.back();
		}
		
		function channelChange(type,limit) {
			selectedChannelType = type;
			var qrcode = document.getElementById("qrcodeWay");
			var bank = document.getElementById("bankWay");
			var aliRedEnvelope = document.getElementById("aliRedEnvelopeWay");
			
			var accountDiv = document.getElementById("accountDiv");
			//clear all disploy;
			qrcode.style.display = 'none';
			bank.style.display = 'none';
			aliRedEnvelope.style.display = 'none';
			accountDiv.style.display = 'none';
			switch(type){
				case 1:
					qrcode.style.display = 'block';
					accountDiv.style.display = 'block';
					qrDaliylimit.value = limit;
					break;				
				case 2:
					bank.style.display = 'block';
					bankDaliylimit.value = limit;
					break;
				case 3:
					aliRedEnvelope.style.display = 'block';
					aliDaliylimit.value = limit;
					break;
				case 4:
					qrcode.style.display = 'block';
					qrDaliylimit.value = limit;
					break;
				
			}
		}
	</script>
</body>
</html>