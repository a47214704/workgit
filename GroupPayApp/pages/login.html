<!doctype html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Login</title>
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<link href="../css/mui.min.css" rel="stylesheet" />
	<link rel="stylesheet" href="../css/own.css" />
</head>
<body>
	<div class="mui-content">
		<div class="logo">
			<img src="../img/logo.png" />
		</div>
		<div class="login-card">
			<div class="mui-input-row">
				<input type="text" value="" id="account" placeholder="请输入手机号" />
			</div>
			<div class="mui-input-row">
				<input type="password" value="" id="password" placeholder="请输入密码" />
			</div>
			<div class="mui-input-row" style="padding-right: 110px;">
				<input type="text" value="" id="captcha" placeholder="验证码" />
				<img src="" class="captcha" id="captchaImg"/>
			</div>
		</div>
		<div style="text-align: right; padding:5px 15px">
			<a href="networkTest.html" style="color: #777;">线路测试</a>
			<a href="#" style="color: #777;">忘记密码？</a>
		</div>
		<div class="mui-button-row" style="padding: 3px 15px;">
			<button id="loginBtn" class="mui-btn own-btn-green mui-btn-block " style="padding: 5px 0px;">登录</button>
		</div>
		<div class="mui-button-row" style="padding: 3px 15px;">
			<font color="red">新用户登录流程</font>
			<ol style="text-align: left;color: blue;padding-left:20%;width: 80%;">
				<li>刚刚注册的新用户，请耐心等候淘金宝客服的电话联系</li>
				<li>如果你填写的手机号码不正确请联系官方微信客服</li>
				<li>等待客服确认后才可以使用</li>
			</ol>
			<font color="blue">官方微信客服</font><br>
			<div id="wxkf"></div>
		</div>
		<div style="text-align: right; padding:5px 15px">
			版本号:<a href="#" style="color: #777;" id="verTag"></a>
		</div>
	</div>
	
	<script src="../js/mui.min.js"></script>
	<script src="../js/update.js"></script>
	<script src="../js/own.js"></script>
	<script src="../js/network.js"></script>
	<script type="text/javascript">
		mui.init({
			swipeBack: false
		});
		
		var regBtn;
		var login;
		var account;
		var password;
		var captcha;
		var captchaImg;
		var loginWebview;
		var wxkf;
		
		mui.plusReady(function(){
			document.getElementById('verTag').innerHTML = curVer;
			login 		= document.getElementById('loginBtn');
			regBtn 		= document.getElementById('regBtn');
			account		= document.getElementById("account");
			password 	= document.getElementById("password");
			captcha		= document.getElementById("captcha");
			captchaImg	= document.getElementById("captchaImg");
			wxkf 		= document.getElementById("wxkf");
			loginWebview = plus.webview.currentWebview();
			
			captchaImg.setAttribute("src", network.captcha_url());
			var tmpAccount = localStorage.getItem('account');
			if (tmpAccount) {
				account.value = tmpAccount;
			}
			
			//登录
			login.addEventListener('tap', function() {
				if (account.value.length <= 0 || !isMobleFormat(account.value)) {
					mui.toast('请输入正确的手机号码');
					return;
				}
				if (password.value.length <= 0){
					mui.toast('请输入密码');
					return;
				}
				if (captcha.value.length <= 0) {
					mui.toast('请输入验证码');
					return;
				}
				network.login({
					captcha: captcha.value,
					account: account.value,
					password: password.value,
				});
			}, false);
			
			//登录成功通知
			loginWebview.addEventListener('hide',function(){
				var mineWebview = plus.webview.getWebviewById('pages/mine.html');
				var homeWebview = plus.webview.getWebviewById('pages/home.html');
				loginWebview.close();
			}, false);
			
			network.get_customer_service_wechat();
			
			//验证码刷新
			captchaImg.addEventListener('tap', function () {
				captchaImg.src = network.captcha_url() + '&r=' + Math.random();
			}, false);
			
			window.addEventListener('refreshCaptch', function(e) {
				captchaImg.src = network.captcha_url() + '&r=' + Math.random();
			});
		});
		
		//登录成功回调
		function loginSuccess(data) {
			var user = {
				id: data.result.userId,
				accountName: account.value,
				balance: 0,
				paddingBalance: 0
			};
			
			localStorage.setItem('userToken', data.result.token);
			localStorage.setItem('account', account.value);
			localStorage.setItem('user', JSON.stringify(user));
			//需要设置密保
			if (data.error == 'more_data') {
				user.security = 0;
				var HBuilder = plus.webview.getWebviewById('HBuilder');
				mui.fire(HBuilder,'newWebView',{
					id:'pages/security-question.html',
					href:'pages/security-question.html',
					aniShow: 'slide-in-bottom',
				});
				mui.toast('为了您的账号安全，请设置密保信息');
			} else {
				user.security = 1;
				mui.toast('登录成功');
			}

			localStorage.setItem('user', JSON.stringify(user));
			loginWebview.hide();
		}
		
		function loginError(code){
			switch(code){
				case 400:
				captchaImg.src = network.captcha_url() + '&r=' + Math.random();
				break;
			}			
		}
		
		function getCustomerServiceWechatSuccess(data){
			var html = "";
			mui.each(data.result.value.split(','), function(index, item) {
				html += '<font color="red" style="padding-left: 10px;">'+ item + 
						'</font><a onclick="copy_fun(\'' + item + '\')">点击复制</a><br>';
			});
			wxkf.innerHTML = html;
		}
		var first = null;
		mui.back = function(){
			if (!first) {
				first = new Date().getTime();
				mui.toast("再按一次退出");
				setTimeout(function(){
					first = null;
				},1000);
			}else {
				if (new Date().getTime() - first < 1000) {
					plus.runtime.quit();
				}
			}
		};
	</script>
</body>
</html>