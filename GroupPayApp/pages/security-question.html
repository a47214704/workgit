<!doctype html>
<html>
<head>
	<meta charset="UTF-8">
	<title>设置密保</title>
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<link href="../css/mui.min.css" rel="stylesheet" />
	<link rel="stylesheet" type="text/css" href="../css/own.css"/>
</head>
<body>
	<header class="mui-bar mui-bar-nav own-bar-nav">
		<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		<h1 class="mui-title">设置密保</h1>
	</header>
	<div class="mui-content"  style="margin: 3px 10px;">
		<div id="container"></div>
		<div class="mui-button-row" style="margin-top:10px">
			<button id="saveBtn" type="button" class="mui-btn own-btn-green mui-btn-block " style="padding: 5px 0px;">保存</button>
		</div>
	</div>
	<script src="../js/mui.min.js"></script>
	<script type="text/javascript" src="../js/own.js" ></script>
	<script type="text/javascript" src="../js/network.js" ></script>
	<script type="text/javascript">
		mui.init({
			swipeBack:true
		});
		
		var saveBtn;
		var container;
		var questionCount;
		var saving = false;
		var currentWebView;
		mui.plusReady(function() {
			saveBtn = document.getElementById("saveBtn");
			container = document.getElementById("container");
			
			//登录成功通知
			currentWebView = plus.webview.currentWebview();
			currentWebView.addEventListener('hide',function(){
				var homeWebview = plus.webview.getWebviewById('pages/home.html');
				mui.fire(homeWebview, 'loginSuccess', {});				
				currentWebView.close();
			}, false);
			
			saveBtn.addEventListener('tap', function(){
				if (saving) return;
				var data = [];
				saving = true;
				for (var i = 0; i < questionCount; i ++) {
					var answer = document.getElementById("question_" + i);
					if (answer.value.length <= 0) {
						mui.toast('请正确填写所有答案');
						saving = false;
						return;
					}
					
					data.push({
						question:{
							id: parseInt(answer.getAttribute('qid'))
						},
						answer: answer.value,
					});
				}
				network.save_question_answer(JSON.parse(localStorage.getItem('user')).id, data);
			});
			
			network.security_question();
		});
		
		function saveAnswerSuccess(data) {
			if (localStorage.getItem('user')) {
				var user = JSON.parse(localStorage.getItem('user'));
				user.security = 1;
				localStorage.setItem('user', JSON.stringify(user));
				mui.toast('密保设置成功');
				setTimeout(function() {
					currentWebView.close();
				}, 1000);
			} else {
				mui.fire(currentWebView.parent(),'newWebView',{
					id:'pages/login.html',
					href:'pages/login.html',
					aniShow: false,
				});
				mui.toast('密保设置成功，请登录');
				currentWebView.close();
			}
		}
		
		function getQuestionSuccess(data) {
			var questions = data.result;
			var html = '';
			questionCount = questions.length;
			
			mui.each(questions, function(index,item) {
				html += '<div class="mui-input-group mt-15">';
				html += '<div class="mui-input-row">';
				html += '<label class="row-label">'+item.question+'</label>';
				html += '</div>';
				html += '<div class="mui-input-row">';
				html += '<input type="text" class="mui-input-clear" qid="'+item.id+'" id="question_'+index+'" placeholder="请输入您的答案">';
				html += '</div></div>';
			});
			
			container.innerHTML = html;
		}
		
	</script>
</body>
</html>